# UIE利润分配提取的流程

## 数据来源
首先通过fintuing layoutlmV3训练版面识别模型，识别出来段落，图片和表格，形成一个方框，然后根据ocr的坐标，把识别成文字组成段落，标题，表格如下：
```
证券代码：000004	证券简称：ST国华	公告编号：2023-011
深圳国华网安科技股份有限公司2022年年度报告摘要


重要提示
    本年度报告摘要来自年度报告全文，为全面了解本公司的经营成果、财务状况及未来发展规划，投资者应当到证监会指定媒体仔细阅读年度报告全文。
    所有董事均已出席了审议本报告的董事会会议。
    非标准审计意见提示
    口适用不适用
    董事会审议的报告期利润分配预案或公积金转增股本预案
    适用不适用
    公司计划不派发现金红利，不送红股，不以公积金转增股本。
    董事会决议通过的本报告期优先股利润分配预案
    适用不适用
二、公司基本情况
    1、公司简介
```
## 数据处理部分
### 获取标注数据
目前最重要的是存在利润预分配方案的文字，使用text2vec模型，将文章中所有的段落，转换成vec，然后利用"公司经本次董事会审议通过的利润分配预案为：以483，649,795为基数，向全体股东每10股派发现金红利1元（含税）送红股0股（含税），以资本公积金向全体股东每10股转增0股"进行查询，可以获得所有有用的目标语料。
### 提取设计
- 分红方案
    - 分红基数
    - 分红金额 
- 分股方案
    - 分股基数
    - 红股股数
- 转增股方案
    - 转增基数
    - 转增股数
- 总基数
### 通过正则式生成标注数据
见parser.py生成固定格式的代码，然后进行提取。

## 模型训练部分
### 生成目标格式数据

```
 python doccano.py     --doccano_file ./data/lifen2.jsonl     --task_type ext     --save_dir ./data     --splits 0.8 0.2 0    
```

### 训练模型
```bash paddlenlp=2.4.0  训练代码
python finetune.py     --train_path ./data/train.txt     --dev_path ./data/dev.txt     --save_dir ./checkpoint     --learning_rate 1e-5     --batch_size 8     --max_seq_len 512     --num_epochs 100     --model uie-base     --seed 1000     --logging_steps 1     --valid_steps 10     --device gpu
```
十分钟左右即可得到较好的效果。
### 查看结果

```python 
from pprint import pprint
from paddlenlp import Taskflow
schema = ['红利基数', '红利金额', '转增基数', '转增股数','总基数','总基数S','红股基数','红股股数']
my_ie = Taskflow("information_extraction", schema=schema, task_path='/home/aistudio/PaddleNLP-2.4.0/model_zoo/uie/checkpoint/model_best')
pprint(my_ie('公司经本次董事会审议通过的利润分配预案为：以1570188160为基数，向全体股东每10股派发现金红利20元（含税），送红股0股（含税），不以公积金转增股本。'))
text="公司于2023年4月14日召开第二届董事会第七次会议，审议通过了《关于2022年度利润分配预案的议案》。公司2022年度利润分配预案为：拟以实施权益分派的股权登记日的总股本为基数，向全体股东每10股派发现金红利人民币4"
pprint(my_ie(text))
```
输出
```json 
[{'总基数': [{'end': 32,
           'probability': 0.881306135449119,
           'start': 22,
           'text': '1570188160'}],
  '总基数S': [{'end': 32,
            'probability': 0.8745342854647049,
            'start': 22,
            'text': '1570188160'}],
  '红利基数': [{'end': 45,
            'probability': 0.9923943632431786,
            'start': 41,
            'text': '每10股'}],
  '红利金额': [{'end': 54,
            'probability': 0.9802970457439457,
            'start': 51,
            'text': '20元'}],
  '红股基数': [{'end': 45,
            'probability': 0.9862807801737432,
            'start': 41,
            'text': '每10股'}],
  '红股股数': [{'end': 64,
            'probability': 0.992184514554495,
            'start': 62,
            'text': '0股'}]}]
[{'总基数': [{'end': 86,
           'probability': 0.6751156770529221,
           'start': 70,
           'text': '实施权益分派的股权登记日的总股本'}],
  '总基数S': [{'end': 86,
            'probability': 0.7166745155128709,
            'start': 70,
            'text': '实施权益分派的股权登记日的总股本'}],
  '红利基数': [{'end': 99,
            'probability': 0.9892281679066528,
            'start': 95,
            'text': '每10股'}],
  '红股基数': [{'end': 99,
            'probability': 0.9906722933793546,
            'start': 95,
            'text': '每10股'}],
  '红股股数': [{'end': 99,
            'probability': 0.49995998749244563,
            'start': 95,
            'text': '每10股'}]}]
```
### 有趣的发现

总基数 和 总基数S 是针对分红基数设计的两种提取方案，一种股权基数是文字（总基数S），一种是数字（总基数），本来训练的时候，是两种数据lifen.txt和lifen2.txt进行训练。
原来是希望模型可以自动区分：对于 ：实施权益分派的股权登记日的总股本 
总基数S 的值不为空，总基数的字为空。反之对应数字情况。
但是实际情况，总基数S和总基数都可以提取到数字，但是可以根据probability来判断究竟是提取的结果属于什么。
